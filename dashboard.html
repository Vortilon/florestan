<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DAE Surveillance Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } }
    };
  </script>
  <style>
    /* Small UI helpers (kept inline for single-file delivery) */
    .tt { position: relative; }
    .tt:hover .ttc { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .ttc {
      position: absolute; left: 50%; transform: translate(-50%, 6px);
      bottom: 120%;
      opacity: 0; pointer-events: none;
      transition: all .12s ease-out;
      white-space: nowrap;
      z-index: 50;
    }
  </style>
</head>

<body class="bg-slate-100 text-slate-900 font-sans">
  <header class="sticky top-0 z-20 border-b border-slate-200 bg-white">
    <div class="mx-auto flex max-w-7xl flex-wrap items-center justify-between gap-4 px-6 py-5">
      <div class="flex items-center gap-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/f/fc/DAE_Logo.jpg" alt="DAE Logo" class="h-8 w-auto max-w-[120px] rounded-sm object-contain" />
        <span class="h-3 w-3 rounded-full bg-red-700"></span>
        <div>
          <h1 class="text-lg font-semibold text-slate-900">Surveillance Dashboard</h1>
          <p class="text-xs text-slate-500">Local XML-backed view (surveillances.xml)</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <span id="buildTag" class="rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-600">V2026-DASH</span>
        <button id="reloadBtn" class="rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50" type="button">
          Reload XML
        </button>
        <button id="resetBtn" class="rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50" type="button">
          Reset local changes
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-6 pb-24 pt-8">
    <section class="rounded-lg bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold text-slate-900">Projects</h2>
          <p class="mt-1 text-sm text-slate-600">
            Filter by any field. All changes are applied instantly (client-side). Local edits persist in your browser.
          </p>
        </div>
        <div class="flex flex-wrap gap-2">
          <span id="countPill" class="rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-600">—</span>
          <span id="xmlPill" class="rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-600">XML: not loaded</span>
        </div>
      </div>

      <!-- Filters -->
      <div class="mt-5 grid gap-3 md:grid-cols-6">
        <div class="md:col-span-2">
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Search</label>
          <input id="q" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="Operator, MSN, Model, FM, Status..." />
        </div>

        <div>
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Operator</label>
          <select id="fOperator" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm"></select>
        </div>

        <div>
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Model</label>
          <select id="fModel" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm"></select>
        </div>

        <div>
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Region</label>
          <select id="fRegion" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm"></select>
        </div>

        <div>
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Status</label>
          <select id="fStatus" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm"></select>
        </div>

        <div class="md:col-span-2">
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">FM</label>
          <select id="fFM" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm"></select>
        </div>

        <div class="md:col-span-2">
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Deadline (from)</label>
          <input id="dFrom" type="date" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm" />
        </div>

        <div class="md:col-span-2">
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Deadline (to)</label>
          <input id="dTo" type="date" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm" />
        </div>

        <div class="md:col-span-6 flex flex-wrap items-center justify-between gap-3 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">
          <div class="text-xs text-slate-600">
            <span class="font-semibold text-slate-700">Legend:</span>
            NOT ASSIGNED → assign contractor · REVIEW PENDING → approve/reject · APPROVED → exports/reports
          </div>
          <button id="clearFiltersBtn" class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50" type="button">
            Clear filters
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="mt-5 overflow-x-auto rounded-lg border border-slate-200 bg-white">
        <table class="min-w-full text-left text-xs text-slate-700">
          <thead class="border-b border-slate-200 bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-400">
            <tr>
              <th class="px-3 py-3">Operator</th>
              <th class="px-3 py-3">MSN</th>
              <th class="px-3 py-3">Model</th>
              <th class="px-3 py-3">Deadline</th>
              <th class="px-3 py-3">FM</th>
              <th class="px-3 py-3">Country</th>
              <th class="px-3 py-3">Region</th>
              <th class="px-3 py-3">Status</th>
              <th class="px-3 py-3">Progress</th>
              <th class="px-3 py-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>

      <p class="mt-3 text-xs text-slate-500">
        Tip: keep <span class="font-mono">surveillances.xml</span> in the same folder as this HTML, then open the HTML using a local web server (recommended).
      </p>
      <div class="mt-2 text-xs text-slate-500">
        Quick local server options:
        <span class="font-mono">python -m http.server 8000</span> or
        <span class="font-mono">npx serve</span>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden bg-black/30 p-4">
    <div class="mx-auto mt-10 max-w-2xl rounded-xl bg-white shadow-lg">
      <div class="flex items-start justify-between gap-4 border-b border-slate-200 px-5 py-4">
        <div>
          <h3 id="modalTitle" class="text-base font-semibold text-slate-900">—</h3>
          <p id="modalSub" class="mt-1 text-xs text-slate-500">—</p>
        </div>
        <button id="modalClose" class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50" type="button">Close</button>
      </div>
      <div id="modalBody" class="px-5 py-4 text-sm text-slate-700"></div>
      <div id="modalFooter" class="flex flex-wrap items-center justify-end gap-2 border-t border-slate-200 px-5 py-4"></div>
    </div>
  </div>

  <footer class="fixed bottom-0 left-0 right-0 border-t border-slate-200 bg-white">
    <div class="mx-auto flex max-w-7xl flex-wrap items-center justify-between gap-3 px-6 py-4">
      <p class="text-xs text-slate-500">Client-side prototype. No backend. Actions update the local view + localStorage only.</p>
      <div class="flex items-center gap-2">
        <button id="downloadEditsBtn" class="rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50" type="button">
          Export local changes (JSON)
        </button>
      </div>
    </div>
  </footer>

<script>
(() => {
  const STORAGE_KEY = "dae_surveillance_local_edits_v1";

  const els = {
    tbody: document.getElementById("tbody"),
    q: document.getElementById("q"),
    fOperator: document.getElementById("fOperator"),
    fModel: document.getElementById("fModel"),
    fRegion: document.getElementById("fRegion"),
    fStatus: document.getElementById("fStatus"),
    fFM: document.getElementById("fFM"),
    dFrom: document.getElementById("dFrom"),
    dTo: document.getElementById("dTo"),
    countPill: document.getElementById("countPill"),
    xmlPill: document.getElementById("xmlPill"),
    reloadBtn: document.getElementById("reloadBtn"),
    resetBtn: document.getElementById("resetBtn"),
    clearFiltersBtn: document.getElementById("clearFiltersBtn"),
    downloadEditsBtn: document.getElementById("downloadEditsBtn"),
    modalBackdrop: document.getElementById("modalBackdrop"),
    modalTitle: document.getElementById("modalTitle"),
    modalSub: document.getElementById("modalSub"),
    modalBody: document.getElementById("modalBody"),
    modalFooter: document.getElementById("modalFooter"),
    modalClose: document.getElementById("modalClose"),
  };

  let contractors = [];
  let projects = [];
  let localEdits = loadLocalEdits();

  const STATUS_PROGRESS = {
    "NOT ASSIGNED": 0,
    "SCHEDULED": 10,
    "ASSIGNED": 20,
    "IN PROGRESS": 60,
    "REVIEW PENDING": 85,
    "SUBMITTED": 85,
    "APPROVED": 100,
    "REJECTED": 100,
  };

  function loadLocalEdits() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }

  function saveLocalEdits() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(localEdits));
  }

  function resetLocalEdits() {
    localEdits = {};
    saveLocalEdits();
    toast("Local changes cleared.");
    render();
  }

  function toast(msg) {
    const d = document.createElement("div");
    d.className = "fixed right-4 top-20 z-[60] rounded-lg border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 shadow-sm";
    d.textContent = msg;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 1600);
  }

  function uniqSorted(values) {
    const s = new Set(values.filter(v => String(v || "").trim() !== ""));
    return Array.from(s).sort((a,b) => String(a).localeCompare(String(b)));
  }

  function setOptions(select, items, placeholder) {
    select.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    select.appendChild(opt0);
    items.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      select.appendChild(o);
    });
  }

  function parseXmlText(xmlText) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlText, "application/xml");
    const err = doc.querySelector("parsererror");
    if (err) throw new Error("XML parse error: " + err.textContent);

    contractors = Array.from(doc.querySelectorAll("contractors > contractor")).map(n => n.textContent.trim());

    const projectNodes = Array.from(doc.querySelectorAll("projects > project"));
    projects = projectNodes.map(node => {
      const get = (tag) => (node.querySelector(tag)?.textContent || "").trim();
      const base = {
        id: node.getAttribute("id") || "",
        operator: get("operator"),
        msn: get("msn"),
        model: get("model"),
        deadline: get("deadline"),
        fm: get("fm"),
        country: get("country"),
        region: get("region"),
        status: get("status") || "NOT ASSIGNED",
        progress: Number(get("progress") || "0"),
        assignedTo: get("assignedTo") || "",
      };

      const patch = localEdits[base.id];
      return patch ? { ...base, ...patch } : base;
    });

    // Fill filter options
    setOptions(els.fOperator, uniqSorted(projects.map(p => p.operator)), "All operators");
    setOptions(els.fModel, uniqSorted(projects.map(p => p.model)), "All models");
    setOptions(els.fRegion, uniqSorted(projects.map(p => p.region)), "All regions");
    setOptions(els.fStatus, uniqSorted(projects.map(p => p.status)), "All statuses");
    setOptions(els.fFM, uniqSorted(projects.map(p => p.fm)), "All FMs");

    els.xmlPill.textContent = "XML: surveillances.xml (" + projects.length + " records)";
  }

  function fmtDate(iso) {
    if (!iso) return "";
    const d = new Date(iso + "T00:00:00");
    if (isNaN(d.getTime())) return iso;
    const m = d.toLocaleString(undefined, { month: "short" });
    return `${d.getDate().toString().padStart(2,"0")}-${m}-${d.getFullYear()}`;
  }

  function statusBadge(status) {
    const s = (status || "").toUpperCase();
    const base = "inline-flex items-center rounded-full border px-2.5 py-1 text-[11px] font-semibold";
    if (s === "APPROVED") return `<span class="${base} border-emerald-200 bg-emerald-50 text-emerald-700">${escapeHtml(status)}</span>`;
    if (s === "REJECTED") return `<span class="${base} border-rose-200 bg-rose-50 text-rose-700">${escapeHtml(status)}</span>`;
    if (s === "IN PROGRESS") return `<span class="${base} border-sky-200 bg-sky-50 text-sky-700">${escapeHtml(status)}</span>`;
    if (s === "REVIEW PENDING" || s === "SUBMITTED") return `<span class="${base} border-amber-200 bg-amber-50 text-amber-700">${escapeHtml(status)}</span>`;
    if (s === "ASSIGNED" || s === "SCHEDULED") return `<span class="${base} border-indigo-200 bg-indigo-50 text-indigo-700">${escapeHtml(status)}</span>`;
    if (s === "NOT ASSIGNED") return `<span class="${base} border-slate-200 bg-slate-50 text-slate-700">${escapeHtml(status)}</span>`;
    return `<span class="${base} border-slate-200 bg-white text-slate-700">${escapeHtml(status)}</span>`;
  }

  function progressBar(pct) {
    const p = Math.max(0, Math.min(100, Number(pct || 0)));
    return `
      <div class="flex items-center gap-2">
        <div class="h-2 w-24 overflow-hidden rounded-full bg-slate-100">
          <div class="h-full bg-slate-900" style="width:${p}%;"></div>
        </div>
        <span class="text-[11px] font-semibold text-slate-600">${p}%</span>
      </div>
    `;
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function iconBtn({ title, svg, onClick, disabled=false }) {
    const dis = disabled ? "opacity-40 pointer-events-none" : "hover:bg-slate-50";
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = `tt inline-flex h-8 w-8 items-center justify-center rounded-lg border border-slate-200 bg-white ${dis}`;
    btn.innerHTML = `
      ${svg}
      <span class="ttc rounded-md border border-slate-200 bg-white px-2 py-1 text-[11px] font-semibold text-slate-700 shadow-sm">${escapeHtml(title)}</span>
    `;
    btn.addEventListener("click", onClick);
    return btn;
  }

  function openModal({ title, sub, bodyHtml, footerButtons=[] }) {
    els.modalTitle.textContent = title || "—";
    els.modalSub.textContent = sub || "";
    els.modalBody.innerHTML = bodyHtml || "";
    els.modalFooter.innerHTML = "";
    footerButtons.forEach(b => els.modalFooter.appendChild(b));
    els.modalBackdrop.classList.remove("hidden");
  }

  function closeModal() {
    els.modalBackdrop.classList.add("hidden");
  }

  function applyEdit(projectId, patch) {
    localEdits[projectId] = { ...(localEdits[projectId] || {}), ...patch };
    saveLocalEdits();
    // Apply in-memory too
    projects = projects.map(p => p.id === projectId ? { ...p, ...patch } : p);
    render();
  }

  function getFiltered() {
    const q = els.q.value.trim().toLowerCase();
    const op = els.fOperator.value;
    const model = els.fModel.value;
    const region = els.fRegion.value;
    const status = els.fStatus.value;
    const fm = els.fFM.value;
    const dFrom = els.dFrom.value ? new Date(els.dFrom.value + "T00:00:00").getTime() : null;
    const dTo = els.dTo.value ? new Date(els.dTo.value + "T23:59:59").getTime() : null;

    return projects.filter(p => {
      if (op && p.operator !== op) return false;
      if (model && p.model !== model) return false;
      if (region && p.region !== region) return false;
      if (status && p.status !== status) return false;
      if (fm && p.fm !== fm) return false;

      const ts = p.deadline ? new Date(p.deadline + "T00:00:00").getTime() : null;
      if (dFrom !== null && ts !== null && ts < dFrom) return false;
      if (dTo !== null && ts !== null && ts > dTo) return false;

      if (!q) return true;
      const hay = [
        p.operator, p.msn, p.model, p.deadline, p.fm, p.country, p.region, p.status, p.assignedTo
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  function viewProject(p) {
    const body = `
      <div class="grid gap-4 md:grid-cols-2">
        <div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Project</div>
          <div class="mt-2 text-sm text-slate-700">
            <div><span class="font-semibold">Operator:</span> ${escapeHtml(p.operator || "—")}</div>
            <div><span class="font-semibold">MSN:</span> ${escapeHtml(p.msn || "—")}</div>
            <div><span class="font-semibold">Model:</span> ${escapeHtml(p.model || "—")}</div>
            <div><span class="font-semibold">Deadline:</span> ${escapeHtml(fmtDate(p.deadline) || "—")}</div>
            <div class="mt-2">${statusBadge(p.status)}</div>
          </div>
        </div>
        <div class="rounded-lg border border-slate-200 bg-white p-4">
          <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Progress</div>
          <div class="mt-2">${progressBar(p.progress ?? STATUS_PROGRESS[p.status] ?? 0)}</div>
          <div class="mt-3 text-xs text-slate-500">
            Assigned to: <span class="font-semibold text-slate-700">${escapeHtml(p.assignedTo || "—")}</span>
          </div>
          <div class="mt-2 text-xs text-slate-500">
            FM: <span class="font-semibold text-slate-700">${escapeHtml(p.fm || "—")}</span>
          </div>
        </div>
      </div>
      <div class="mt-4 rounded-lg border border-slate-200 bg-white p-4">
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Notes</div>
        <textarea id="noteBox" class="mt-2 min-h-[90px] w-full rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="Optional notes (saved locally)">${escapeHtml((p.notes || ""))}</textarea>
      </div>
    `;

    const saveBtn = document.createElement("button");
    saveBtn.type = "button";
    saveBtn.className = "rounded-lg bg-slate-900 px-4 py-2 text-xs font-semibold text-white";
    saveBtn.textContent = "Save notes";
    saveBtn.addEventListener("click", () => {
      const note = document.getElementById("noteBox")?.value || "";
      applyEdit(p.id, { notes: note });
      toast("Saved.");
      closeModal();
    });

    openModal({
      title: `Report: ${p.operator || "—"} / MSN ${p.msn || "—"}`,
      sub: `Project ID: ${p.id}`,
      bodyHtml: body,
      footerButtons: [saveBtn],
    });
  }

  function assignProject(p) {
    const options = contractors.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    const body = `
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm">
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Assign Contractor</div>
        <div class="mt-2 text-slate-700">
          Operator: <span class="font-semibold">${escapeHtml(p.operator)}</span> · MSN: <span class="font-semibold">${escapeHtml(p.msn)}</span>
        </div>
        <label class="mt-4 block text-[11px] font-semibold uppercase tracking-wide text-slate-400">Contractor (Technical Rep)</label>
        <select id="contractorSel" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
          <option value="">Select…</option>
          ${options}
        </select>

        <label class="mt-3 block text-[11px] font-semibold uppercase tracking-wide text-slate-400">New Status</label>
        <select id="assignStatusSel" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
          <option value="ASSIGNED">ASSIGNED</option>
          <option value="SCHEDULED">SCHEDULED</option>
          <option value="IN PROGRESS">IN PROGRESS</option>
        </select>
      </div>
    `;

    const assignBtn = document.createElement("button");
    assignBtn.type = "button";
    assignBtn.className = "rounded-lg bg-slate-900 px-4 py-2 text-xs font-semibold text-white";
    assignBtn.textContent = "Assign";
    assignBtn.addEventListener("click", () => {
      const c = document.getElementById("contractorSel").value;
      const st = document.getElementById("assignStatusSel").value;
      if (!c) { toast("Select a contractor."); return; }
      applyEdit(p.id, {
        assignedTo: c,
        status: st,
        progress: STATUS_PROGRESS[st] ?? 0
      });
      closeModal();
      toast("Assigned.");
    });

    openModal({
      title: "Assign project",
      sub: `${p.operator} · MSN ${p.msn}`,
      bodyHtml: body,
      footerButtons: [assignBtn],
    });
  }

  function approveReject(p, decision) {
    const next = decision === "APPROVE" ? "APPROVED" : "REJECTED";
    const body = `
      <div class="rounded-lg border border-slate-200 bg-white p-4 text-sm text-slate-700">
        Set status to <span class="font-semibold">${next}</span> for:
        <div class="mt-2 text-xs text-slate-500">${escapeHtml(p.operator)} · MSN ${escapeHtml(p.msn)} · ${escapeHtml(p.model || "")}</div>
      </div>
    `;
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "rounded-lg bg-slate-900 px-4 py-2 text-xs font-semibold text-white";
    btn.textContent = next;
    btn.addEventListener("click", () => {
      applyEdit(p.id, { status: next, progress: 100 });
      closeModal();
      toast("Updated.");
    });
    openModal({ title: "Review decision", sub: `Project ID: ${p.id}`, bodyHtml: body, footerButtons: [btn] });
  }

  function exportsAndReports(p) {
    const body = `
      <div class="space-y-3">
        <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
          Approved record. Choose an action below.
        </div>

        <div class="grid gap-2 md:grid-cols-2">
          <button data-act="xrm" class="actionBtn rounded-lg border border-slate-200 bg-white px-4 py-3 text-left text-sm hover:bg-slate-50">
            <div class="font-semibold">Export to xRM</div>
            <div class="mt-1 text-xs text-slate-500">Shows XML placeholder aligned to export standards.</div>
          </button>

          <button data-act="ats" class="actionBtn rounded-lg border border-slate-200 bg-white px-4 py-3 text-left text-sm hover:bg-slate-50">
            <div class="font-semibold">Export to ATS</div>
            <div class="mt-1 text-xs text-slate-500">Explains ATS upload packaging + naming protocol.</div>
          </button>

          <button data-act="detailspec" class="actionBtn rounded-lg border border-slate-200 bg-white px-4 py-3 text-left text-sm hover:bg-slate-50">
            <div class="font-semibold">Generate Detail Spec</div>
            <div class="mt-1 text-xs text-slate-500">Prototype: shows what will be pulled into a PDF.</div>
          </button>

          <button data-act="airreport" class="actionBtn rounded-lg border border-slate-200 bg-white px-4 py-3 text-left text-sm hover:bg-slate-50">
            <div class="font-semibold">AIR Report</div>
            <div class="mt-1 text-xs text-slate-500">Prototype: report PDF generation placeholder.</div>
          </button>
        </div>

        <div class="rounded-lg border border-slate-200 bg-white p-4">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Record snapshot</div>
          <pre class="mt-2 overflow-auto rounded-lg bg-slate-900 p-3 text-[11px] text-slate-100">${escapeHtml(JSON.stringify(p, null, 2))}</pre>
        </div>
      </div>
    `;

    openModal({
      title: "Exports & Reports",
      sub: `${p.operator} · MSN ${p.msn}`,
      bodyHtml: body,
      footerButtons: [],
    });

    // Wire buttons after modal renders
    setTimeout(() => {
      document.querySelectorAll(".actionBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          if (act === "xrm") {
            openModal({
              title: "Export to xRM (prototype)",
              sub: "XML placeholder",
              bodyHtml: `
                <div class="rounded-lg border border-slate-200 bg-white p-4 text-sm text-slate-700">
                  <div class="mb-3">XML To export to XML standards</div>
                  <pre class="overflow-auto rounded-lg bg-slate-900 p-3 text-[11px] text-slate-100">${escapeHtml(projectToExportXml(p))}</pre>
                </div>
              `,
              footerButtons: []
            });
          } else if (act === "ats") {
            openModal({
              title: "Export to ATS (prototype)",
              sub: "Packaging explanation",
              bodyHtml: `
                <div class="rounded-lg border border-slate-200 bg-white p-4 text-sm text-slate-700">
                  ALl available records and photos will be made available for ATS upload in acordance with the files names protocol and ATS standard
                </div>
              `,
              footerButtons: []
            });
          } else {
            openModal({
              title: (act === "detailspec") ? "Detail Spec (PDF placeholder)" : "AIR Report (PDF placeholder)",
              sub: "PDF generation placeholder",
              bodyHtml: `
                <div class="rounded-lg border border-slate-200 bg-white p-4 text-sm text-slate-700">
                  Prototype only. Next step: generate a PDF from report data.
                  <div class="mt-3 rounded-lg border border-slate-200 bg-slate-50 p-3 text-xs text-slate-600">
                    Would extract all report fields + tables for the selected MSN and render a PDF.
                  </div>
                </div>
              `,
              footerButtons: []
            });
          }
        });
      });
    }, 0);
  }

  function projectToExportXml(p) {
    // simple export payload stub (replace later with formal xRM schema)
    const esc = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");
    return `<?xml version="1.0" encoding="UTF-8"?>\n<crmExport>\n  <surveillance>\n    <operator>${esc(p.operator)}</operator>\n    <msn>${esc(p.msn)}</msn>\n    <model>${esc(p.model)}</model>\n    <deadline>${esc(p.deadline)}</deadline>\n    <region>${esc(p.region)}</region>\n    <status>${esc(p.status)}</status>\n    <assignedTo>${esc(p.assignedTo || "")}</assignedTo>\n  </surveillance>\n</crmExport>`;
  }

  function render() {
    const filtered = getFiltered();
    els.countPill.textContent = `${filtered.length} / ${projects.length} shown`;

    els.tbody.innerHTML = "";
    filtered.forEach(p => {
      const tr = document.createElement("tr");
      tr.className = "hover:bg-slate-50";
      tr.innerHTML = `
        <td class="px-3 py-3 whitespace-nowrap">${escapeHtml(p.operator)}</td>
        <td class="px-3 py-3 whitespace-nowrap font-semibold text-slate-900">${escapeHtml(p.msn)}</td>
        <td class="px-3 py-3 whitespace-nowrap">${escapeHtml(p.model)}</td>
        <td class="px-3 py-3 whitespace-nowrap">${escapeHtml(fmtDate(p.deadline))}</td>
        <td class="px-3 py-3 whitespace-nowrap">${escapeHtml(p.fm)}</td>
        <td class="px-3 py-3 whitespace-nowrap">${escapeHtml(p.country)}</td>
        <td class="px-3 py-3 whitespace-nowrap">${escapeHtml(p.region)}</td>
        <td class="px-3 py-3 whitespace-nowrap">${statusBadge(p.status)}</td>
        <td class="px-3 py-3 whitespace-nowrap">${progressBar(p.progress ?? STATUS_PROGRESS[p.status] ?? 0)}</td>
        <td class="px-3 py-2 whitespace-nowrap">
          <div class="flex items-center justify-end gap-2" data-actions></div>
        </td>
      `;

      const actionsCell = tr.querySelector("[data-actions]");

      // Icons (inline SVGs)
      const eye = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7S2 12 2 12z"/><circle cx="12" cy="12" r="3"/></svg>`;
      const userPlus = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg>`;
      const check = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>`;
      const x = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>`;
      const report = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8"/><path d="M8 17h8"/><path d="M8 9h2"/></svg>`;

      actionsCell.appendChild(iconBtn({ title: "Open", svg: eye, onClick: () => viewProject(p) }));

      const st = (p.status || "").toUpperCase();
      if (st === "NOT ASSIGNED") {
        actionsCell.appendChild(iconBtn({ title: "Assign", svg: userPlus, onClick: () => assignProject(p) }));
      } else if (st === "REVIEW PENDING" || st === "SUBMITTED") {
        actionsCell.appendChild(iconBtn({ title: "Approve", svg: check, onClick: () => approveReject(p, "APPROVE") }));
        actionsCell.appendChild(iconBtn({ title: "Reject", svg: x, onClick: () => approveReject(p, "REJECT") }));
      } else if (st === "APPROVED") {
        actionsCell.appendChild(iconBtn({ title: "Reports / Exports", svg: report, onClick: () => exportsAndReports(p) }));
      } else {
        // Keep layout consistent
        actionsCell.appendChild(iconBtn({ title: "Reports / Exports", svg: report, onClick: () => exportsAndReports(p), disabled: true }));
      }

      els.tbody.appendChild(tr);
    });
  }

  async function loadXml() {
    // Load local file if served by http(s). If opened as file://, fetch will be blocked by many browsers.
    try {
      const res = await fetch("surveillances.xml", { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const txt = await res.text();
      parseXmlText(txt);
      toast("XML loaded.");
      render();
    } catch (e) {
      els.xmlPill.textContent = "XML: failed to load (open via local server)";
      console.error(e);
      toast("Failed to load XML. Use a local server.");
      // Still render empty table
      render();
    }
  }

  function wireFilters() {
    const inputs = [els.q, els.fOperator, els.fModel, els.fRegion, els.fStatus, els.fFM, els.dFrom, els.dTo];
    inputs.forEach(el => el.addEventListener("input", render));
    inputs.forEach(el => el.addEventListener("change", render));

    els.clearFiltersBtn.addEventListener("click", () => {
      els.q.value = "";
      els.fOperator.value = "";
      els.fModel.value = "";
      els.fRegion.value = "";
      els.fStatus.value = "";
      els.fFM.value = "";
      els.dFrom.value = "";
      els.dTo.value = "";
      render();
    });

    els.reloadBtn.addEventListener("click", loadXml);
    els.resetBtn.addEventListener("click", resetLocalEdits);

    els.modalBackdrop.addEventListener("click", (e) => { if (e.target === els.modalBackdrop) closeModal(); });
    els.modalClose.addEventListener("click", closeModal);

    els.downloadEditsBtn.addEventListener("click", () => {
      const payload = JSON.stringify(localEdits, null, 2);
      const blob = new Blob([payload], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "surveillance_local_changes.json";
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  // Init filter selects with placeholders
  setOptions(els.fOperator, [], "All operators");
  setOptions(els.fModel, [], "All models");
  setOptions(els.fRegion, [], "All regions");
  setOptions(els.fStatus, [], "All statuses");
  setOptions(els.fFM, [], "All FMs");

  wireFilters();
  loadXml();
})();
</script>
</body>
</html>
