<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Report Viewer - DAE</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } }
    };
  </script>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
  <header class="sticky top-0 z-20 border-b border-slate-200 bg-white shadow-sm">
    <div class="mx-auto flex max-w-6xl items-center justify-between gap-4 px-4 md:px-6 py-3 md:py-4">
      <div class="flex items-center gap-3">
        <a href="index.html" class="flex items-center gap-2 text-slate-600 hover:text-slate-900">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          <span class="text-sm font-medium">Back to Dashboard</span>
        </a>
      </div>
      <div>
        <h1 class="text-base md:text-lg font-semibold text-slate-900">Report Viewer</h1>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 md:px-6 pb-24 pt-6 md:pt-8">
    <!-- Report Header -->
    <section class="rounded-lg bg-white p-4 md:p-6 shadow-sm mb-6">
      <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
        <div>
          <h2 class="text-xl md:text-2xl font-semibold text-slate-900" id="reportTitle">Aircraft Inspection Report</h2>
          <p class="mt-1 text-sm text-slate-600" id="reportSubtitle">Loading report data...</p>
        </div>
        <div class="flex flex-wrap gap-2">
          <span id="reportStatus" class="rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-600">—</span>
        </div>
      </div>

      <!-- Export Buttons -->
      <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-4 mt-6">
        <button id="exportXrmBtn" class="export-btn flex flex-col items-center gap-2 rounded-lg border border-slate-200 bg-white p-4 hover:bg-slate-50 active:bg-slate-100 transition-colors min-h-[100px]">
          <svg class="w-8 h-8 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
          </svg>
          <span class="text-xs font-semibold text-slate-700">Export to xRM</span>
        </button>

        <button id="exportAtsBtn" class="export-btn flex flex-col items-center gap-2 rounded-lg border border-slate-200 bg-white p-4 hover:bg-slate-50 active:bg-slate-100 transition-colors min-h-[100px]">
          <svg class="w-8 h-8 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <span class="text-xs font-semibold text-slate-700">Export to ATS</span>
        </button>

        <button id="exportDetailSpecBtn" class="export-btn flex flex-col items-center gap-2 rounded-lg border border-slate-200 bg-white p-4 hover:bg-slate-50 active:bg-slate-100 transition-colors min-h-[100px]">
          <svg class="w-8 h-8 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <span class="text-xs font-semibold text-slate-700">Detail Spec</span>
        </button>

        <button id="exportAirReportBtn" class="export-btn flex flex-col items-center gap-2 rounded-lg border border-slate-200 bg-white p-4 hover:bg-slate-50 active:bg-slate-100 transition-colors min-h-[100px]">
          <svg class="w-8 h-8 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <span class="text-xs font-semibold text-slate-700">AIR Report</span>
        </button>
      </div>
    </section>

    <!-- Report Content -->
    <section class="rounded-lg bg-white p-4 md:p-6 shadow-sm mb-6">
      <h3 class="text-lg md:text-xl font-semibold text-slate-900 mb-4">Report Summary</h3>
      <div id="reportContent" class="space-y-4 text-sm text-slate-700">
        <p>Loading report content...</p>
      </div>
    </section>
  </main>

  <!-- Export Modal -->
  <div id="exportModal" class="fixed inset-0 z-50 hidden bg-black/30 p-4">
    <div class="mx-auto mt-10 max-w-2xl w-full rounded-xl bg-white shadow-lg max-h-[90vh] overflow-y-auto">
      <div class="flex items-start justify-between gap-4 border-b border-slate-200 px-4 md:px-5 py-4 sticky top-0 bg-white">
        <div>
          <h3 id="exportModalTitle" class="text-sm md:text-base font-semibold text-slate-900">Export</h3>
          <p id="exportModalSub" class="mt-1 text-[10px] md:text-xs text-slate-500">Export Information</p>
        </div>
        <button id="closeExportModal" class="rounded-lg border border-slate-200 bg-white px-2 md:px-3 py-1 md:py-1.5 text-[10px] md:text-xs font-semibold text-slate-700 hover:bg-slate-50" type="button">✕</button>
      </div>
      <div id="exportModalBody" class="px-4 md:px-5 py-4 text-xs md:text-sm text-slate-700">
        <!-- Populated by JavaScript -->
      </div>
      <div class="flex flex-wrap items-center justify-end gap-2 border-t border-slate-200 px-4 md:px-5 py-4 sticky bottom-0 bg-white">
        <button id="exportModalCloseBtn" class="rounded-lg border border-slate-200 bg-white px-3 md:px-4 py-1.5 md:py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get("project") || "demo_project";

      const els = {
        reportTitle: document.getElementById("reportTitle"),
        reportSubtitle: document.getElementById("reportSubtitle"),
        reportStatus: document.getElementById("reportStatus"),
        reportContent: document.getElementById("reportContent"),
        exportModal: document.getElementById("exportModal"),
        exportModalTitle: document.getElementById("exportModalTitle"),
        exportModalSub: document.getElementById("exportModalSub"),
        exportModalBody: document.getElementById("exportModalBody"),
        closeExportModal: document.getElementById("closeExportModal"),
        exportModalCloseBtn: document.getElementById("exportModalCloseBtn"),
        exportXrmBtn: document.getElementById("exportXrmBtn"),
        exportAtsBtn: document.getElementById("exportAtsBtn"),
        exportDetailSpecBtn: document.getElementById("exportDetailSpecBtn"),
        exportAirReportBtn: document.getElementById("exportAirReportBtn"),
      };

      const exportDescriptions = {
        xrm: {
          title: "Export to xRM",
          description: "This export will generate an XML file formatted according to xRM (CRM system) standards. The export includes:",
          details: [
            "All surveillance project data (operator, MSN, model, dates)",
            "Inspection findings and technical specifications",
            "Status and progress information",
            "Assigned contractor and FM details",
            "Formatted according to xRM XML schema requirements"
          ],
          note: "The exported XML file can be directly imported into the xRM system for tracking and management."
        },
        ats: {
          title: "Export to ATS",
          description: "This export will package all records and photos according to ATS (Aircraft Technical System) file naming protocol and upload standards. The export includes:",
          details: [
            "All supporting documentation files",
            "Inspection photos organized by location",
            "Technical specifications and maintenance records",
            "Files renamed according to ATS naming convention",
            "Package ready for ATS upload"
          ],
          note: "All files will be organized and named according to ATS standards. Only documents not already available on ATS will be included."
        },
        detailspec: {
          title: "Generate Detail Specification",
          description: "This will generate a PDF Detail Specification document containing:",
          details: [
            "Complete technical specifications for the aircraft",
            "All inspection findings and recommendations",
            "Component details (engines, gears, propellers, etc.)",
            "Maintenance program information",
            "Operating weights and certifications"
          ],
          note: "The PDF will be formatted as a professional specification document suitable for technical review and documentation."
        },
        airreport: {
          title: "Generate AIR Report",
          description: "This will generate the complete AIR (Aircraft Inspection Report) PDF with:",
          details: [
            "All sections from the inspection report (Sections 1-5)",
            "Executive summary and findings",
            "Physical inspection checklist results",
            "All inspection photos embedded in the report",
            "Supporting documentation references"
          ],
          note: "The AIR report PDF will be formatted according to DAE standards and can be used for official documentation and regulatory submissions."
        }
      };

      function openExportModal(type) {
        const exportInfo = exportDescriptions[type];
        if (!exportInfo) return;

        els.exportModalTitle.textContent = exportInfo.title;
        els.exportModalSub.textContent = "Export Information";
        els.exportModalBody.innerHTML = `
          <div class="space-y-4">
            <p class="text-sm text-slate-700">${exportInfo.description}</p>
            <ul class="list-disc list-inside space-y-2 text-sm text-slate-600 ml-4">
              ${exportInfo.details.map(detail => `<li>${detail}</li>`).join("")}
            </ul>
            <div class="rounded-lg border border-slate-200 bg-slate-50 p-3 md:p-4">
              <p class="text-xs md:text-sm text-slate-600"><strong>Note:</strong> ${exportInfo.note}</p>
            </div>
            <div class="rounded-lg border border-amber-200 bg-amber-50 p-3 md:p-4">
              <p class="text-xs md:text-sm text-amber-800"><strong>Prototype:</strong> This is a demonstration. In the full version, clicking "Export" will generate and download the actual file.</p>
            </div>
          </div>
        `;
        els.exportModal.classList.remove("hidden");
      }

      function closeExportModal() {
        els.exportModal.classList.add("hidden");
      }

      async function loadReportData() {
        try {
          // Load project data
          const response = await fetch("data/surveillances.json");
          const data = await response.json();
          const project = data.projects.find(p => p.id === projectId);

          if (project) {
            els.reportTitle.textContent = `${project.operator} - MSN ${project.msn}`;
            els.reportSubtitle.textContent = `${project.model} · ${project.region} · Deadline: ${new Date(project.deadline).toLocaleDateString()}`;
            els.reportStatus.textContent = project.status;
            els.reportStatus.className = `rounded-full border px-3 py-1 text-xs font-semibold ${
              project.status === "APPROVED" ? "border-emerald-200 bg-emerald-50 text-emerald-700" :
              project.status === "REJECTED" ? "border-rose-200 bg-rose-50 text-rose-700" :
              "border-slate-200 bg-slate-50 text-slate-600"
            }`;

            // Load report data from localStorage
            const reportData = localStorage.getItem(`dae_inspection_data_${projectId}`);
            if (reportData) {
              const parsed = JSON.parse(reportData);
              els.reportContent.innerHTML = `
                <div class="grid gap-4 md:grid-cols-2">
                  <div class="rounded-lg border border-slate-200 bg-slate-50 p-3 md:p-4">
                    <div class="text-xs font-semibold uppercase tracking-wide text-slate-400 mb-2">Report Information</div>
                    <div class="text-sm text-slate-700 space-y-1">
                      <div><strong>Inspector:</strong> ${parsed.inspector_name || "—"}</div>
                      <div><strong>Report Date:</strong> ${parsed.report_date || "—"}</div>
                      <div><strong>Physical Inspection Date:</strong> ${parsed.physical_date || "—"}</div>
                    </div>
                  </div>
                  <div class="rounded-lg border border-slate-200 bg-white p-3 md:p-4">
                    <div class="text-xs font-semibold uppercase tracking-wide text-slate-400 mb-2">Aircraft Details</div>
                    <div class="text-sm text-slate-700 space-y-1">
                      <div><strong>MSN:</strong> ${parsed.msn || "—"}</div>
                      <div><strong>Registration:</strong> ${parsed.registration || "—"}</div>
                      <div><strong>Aircraft Type:</strong> ${parsed.aircraft_type || "—"}</div>
                    </div>
                  </div>
                </div>
                <div class="mt-4 text-xs text-slate-500">
                  Report contains ${Object.keys(parsed).length} data fields. Full report view will be available in the complete version.
                </div>
              `;
            } else {
              els.reportContent.innerHTML = `
                <p class="text-sm text-slate-600">No report data found for this project. The report may not have been completed yet.</p>
              `;
            }
          }
        } catch (e) {
          console.error("Error loading report data:", e);
          els.reportContent.innerHTML = `
            <p class="text-sm text-red-600">Error loading report data. Please check the console for details.</p>
          `;
        }
      }

      // Event listeners
      els.exportXrmBtn.addEventListener("click", () => openExportModal("xrm"));
      els.exportAtsBtn.addEventListener("click", () => openExportModal("ats"));
      els.exportDetailSpecBtn.addEventListener("click", () => openExportModal("detailspec"));
      els.exportAirReportBtn.addEventListener("click", () => openExportModal("airreport"));
      els.closeExportModal.addEventListener("click", closeExportModal);
      els.exportModalCloseBtn.addEventListener("click", closeExportModal);
      els.exportModal.addEventListener("click", (e) => {
        if (e.target === els.exportModal) closeExportModal();
      });

      // Load data on page load
      loadReportData();
    })();
  </script>
</body>
</html>

